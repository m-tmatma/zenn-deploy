---
title: "python ã§ ssh ã§ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ (pxssh ã§ \"su -\" ã‚’å®Ÿè¡Œã™ã‚‹)"
emoji: "ğŸ“‘"
type: "tech"
topics:
  - "python"
  - "ssh"
  - "su"
  - "pxssh"
published: true
published_at: "2023-11-12 16:51"
---

## æ¦‚è¦

python ã§ pexpect ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® pxssh ã‚’ä½¿ã†ã“ã¨ã§ `su -` ã‚’å«ã‚ãŸã‚³ãƒãƒ³ãƒ‰é€ä¿¡å‡¦ç†ã‚’è‡ªå‹•åŒ–ã§ãã‚‹ã€‚ãã®æ‰‹é †ã‚’èª¬æ˜ã™ã‚‹ã€‚

## æœ€çµ‚ã‚³ãƒ¼ãƒ‰

```
#!/usr/bin/python3
# pxssh ã‚’åˆ©ç”¨ã—ãŸ "su -" ã®ãƒ†ã‚¹ãƒˆ
import sys
import re

from pexpect import pxssh

def login_ssh(server: str, username: str, password: str):
    # ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’è¨­å®šã—SSHã‚µãƒ¼ãƒãƒ¼ã«ãƒ­ã‚°ã‚¤ãƒ³
    ssh = pxssh.pxssh(options={
                    "StrictHostKeyChecking": "no",
                    "UserKnownHostsFile": "/dev/null"})

    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è¨­å®š (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
    ssh.UNIQUE_PROMPT = r"[\$\#] "
    ssh.PROMPT = ssh.UNIQUE_PROMPT
    ssh.PROMPT_SET_SH = r"PS1='\$ '"
    ssh.PROMPT_SET_CSH = r"set prompt='\$ '"
    ssh.PROMPT_SET_ZSH = "prompt restore;\nPS1='%(!.#.$) '"

    ssh.login(server=server,
            username=username,
            password=password,
            port=22)
    print(ssh.before.decode(encoding='utf-8'), flush=True, end="")
    print(ssh.after.decode(encoding='utf-8'), flush=True, end="")
    return ssh

def sendline_and_print(ssh, command: str):
    print(f"{command}")
    ssh.sendline(command)

def run_command(ssh, command: str):
    sendline_and_print(ssh, command)

    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    while True:
        index = ssh.expect_list(
            [
                re.compile(r".*(#|\$) ".encode()),   # ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                re.compile(r"\n".encode()),
            ], timeout = 10)
        print(ssh.before.decode(encoding='utf-8'), flush=True, end="")
        print(ssh.after.decode(encoding='utf-8'), flush=True, end="")
        if index == 0:
            break

def send_commands(ssh):
    run_command(ssh, "touch test.txt")
    run_command(ssh, "ls -l")

def switch_to_root(ssh, root_pass: str):
    sendline_and_print(ssh, "su -")

    # rootã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    ssh.expect(r".*: ")
    print(ssh.before.decode(encoding='utf-8'), flush=True, end="")
    print(ssh.after.decode(encoding='utf-8'), flush=True, end="")

    ssh.sendline(root_pass)

    # root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    index = ssh.expect_list(
        [
            re.compile(r".*# ".encode()),   # root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            re.compile(r"su: .*".encode()), # "su: Authentication failure" or "su: èªè¨¼å¤±æ•—"
        ], timeout = 10)
    if index != 0:
        print("failed to switch to root")
        sys.exit(1)
    print(ssh.before.decode(encoding='utf-8'), flush=True, end="")
    print(ssh.after.decode(encoding='utf-8'), flush=True, end="")

def send_commands_root(ssh):
    run_command(ssh, "ls -l")
    run_command(ssh, "find /etc")

    run_command(ssh, "id")
    run_command(ssh, "exit")

if __name__ == "__main__":
    if len(sys.argv) < 5:
        print(f"Usage: python3 {sys.argv[0]} <server> <username> <password> <root_password>")
        sys.exit(1)

    server = sys.argv[1]
    username = sys.argv[2]
    password = sys.argv[3]
    root_pass = sys.argv[4]

    ssh = login_ssh(server, username, password)
    send_commands(ssh)
    switch_to_root(ssh, root_pass=root_pass)
    send_commands_root(ssh)

    ssh.logout()
```

## èª¬æ˜

### å¿…è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

```
from pexpect import pxssh
```


### pxssh ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–

`pxssh` ã‚’ã‚¤ãƒ³ã‚¿ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹ã€‚
ã“ã®éš›ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã€‚

https://pexpect.readthedocs.io/en/stable/api/pxssh.html#pexpect.pxssh.pxssh.options

```
    ssh = pxssh.pxssh(options={
                    "StrictHostKeyChecking": "no",
                    "UserKnownHostsFile": "/dev/null"})
```

### ssh æ¥ç¶šã™ã‚‹ã€‚

```
    ssh.login(server=server,
            username=username,
            password=password,
            port=22)
```

### ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ & ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå®Œäº†å¾…ã¡

æ–‡å­—åˆ— command ã§æŒ‡å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’ ssh çµŒç”±ã§é€ä¿¡ã—ã¦ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã™ã‚‹ã€‚

```
    ssh.sendline(command)
```

`ssh.expect_list` ã§æŒ‡å®šã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã„ãšã‚Œã‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤ã€‚
ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ã€
ã‚ã‚‹ã„ã¯æ”¹è¡Œã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤ã€‚

ã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã—ãŸã‹æˆ»ã‚Šå€¤ã§è¿”ã™ã®ã§ã€ãã‚Œã«åŸºã¥ã„ã¦å ´åˆåˆ†ã‘ã‚’ã™ã‚‹ã€‚
ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ã§ã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚‚ä¸€è‡´ã—ãªã„å ´åˆã¯ -1 ã‚’è¿”ã™ã€‚

ã‚³ãƒãƒ³ãƒ‰è‡ªä½“ãŒã„ã¤ã¾ã§ã‚‚çµ‚ã‚ã‚‰ãªã„å ´åˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã¯å¿…è¦ã‹ã‚‚


```
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    while True:
        index = ssh.expect_list(
            [
                re.compile(r".*(#|\$) ".encode()),   # ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                re.compile(r"\n".encode()),
            ], timeout = 10)
        print(ssh.before.decode(encoding='utf-8'), flush=True, end="")
        print(ssh.after.decode(encoding='utf-8'), flush=True, end="")
        if index == 0:
            break
```

ãªãŠã€`ssh.before` ã§ `expect` å‘¼ã³å‡ºã—ã‚ˆã‚Šå‰ã®å‡ºåŠ›ã‚’å–å¾—ã§ãã‚‹ã€‚
`ssh.after` ã§ `expect` å‘¼ã³å‡ºã—ã‚ˆã‚Šå¾Œã®å‡ºåŠ›ã‚’å–å¾—ã§ãã‚‹ã€‚

### `su -` ã‚’å®Ÿè¡Œã—ã¦ root ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã€‚

`su -` ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```
    ssh.sendline("su -")
```

`su -` ã‚’å®Ÿè¡Œå¾Œè¡¨ç¤ºã•ã‚Œã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ç¢ºèªãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤

```
    ssh.expect(r".*: ")
```

root ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹ã€‚

```
    ssh.sendline(root_pass)
```

### root ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡çµæœã‚’ç¢ºèªã™ã‚‹ã€‚

root ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ã„å ´åˆã€root ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
root ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒèª¤ã‚Šã®å ´åˆã€`su: Authentication failure` ã‚ã‚‹ã„ã¯ `su: èªè¨¼å¤±æ•—` ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

ã“ã‚Œã‚‰ã®ã„ãšã‚Œã‹ã®æ–‡å­—åˆ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ã€‚

`expect` ã§å¾…ã¤å ´åˆã¯å˜ã«æ–‡å­—åˆ—ã‚’æ¸¡ã›ã°ã‚ˆã„ãŒã€
`expect_list` ã§è¤‡æ•°ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¸¡ã™å ´åˆã¯ `re.compile` ã§æ­£è¦è¡¨ç¾ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ã€‚ã‹ã¤ã€`re.compile`ã«æ¸¡ã™ãƒ‡ãƒ¼ã‚¿ã¯ bytes ãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ã“ã®ãŸã‚ UTF-8 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ bytes ãƒ‡ãƒ¼ã‚¿ã«ã—ãŸé…åˆ—ã‚’æ¸¡ã™ã€‚

```
    index = ssh.expect_list(
        [
            re.compile(r".*# ".encode()),   # root ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            re.compile(r"su: .*".encode()), # "su: Authentication failure" or "su: èªè¨¼å¤±æ•—"
        ], timeout = 10)
    if index != 0:
        print("failed to switch to root")
        sys.exit(1)
```

ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã—ãŸå ´åˆã€ãƒãƒƒãƒã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™ã®ã§ã€rootã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ä¸€è‡´ã—ãŸå ´åˆä»¥å¤–ã§ã¯ã‚¨ãƒ©ãƒ¼çµ‚äº†ã™ã‚‹ã€‚
ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ã§ã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚‚ä¸€è‡´ã—ãªã„å ´åˆã‚‚ã‚¨ãƒ©ãƒ¼çµ‚äº†ã™ã‚‹ã€‚

### root ã‚·ã‚§ãƒ«ã®çµ‚äº†

`su -` ã§ root ã«ãªã£ãŸå¾Œ `exit` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ root ã‚·ã‚§ãƒ«ã‚’çµ‚äº†ã™ã‚‹ã€‚

### ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

root ã‚·ã‚§ãƒ«çµ‚äº†å¾Œã€`ssh.logout()` ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã€‚

## ã‚³ãƒ¼ãƒ‰

https://github.com/m-tmatma/pxssh_test