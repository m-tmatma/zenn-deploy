---
title: "NAND simulator ã®ä½¿ç”¨æ–¹æ³•"
emoji: "ğŸ“˜"
type: "tech"
topics:
  - "linux"
  - "nand"
  - "nandsim"
published: true
published_at: "2022-08-14 17:46"
---

# NAND simulator ã®ä½¿ç”¨æ–¹æ³•

NAND simulator(nandsim) ã¨ã„ã† RAMãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã§ NAND ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ãƒ‰ãƒ©ã‚¤ãƒãŒã‚ã‚‹ã€‚

`modprobe nandsim` ã§ nandsim ã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ãŒã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒ‡å®šã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚

ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ãŒã€first_id_byte, second_id_byte, third_id_byte, fourth_id_byte ã®å¼•æ•°ã‚’æŒ‡å®šã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŒã€ä½•ã‚’æŒ‡å®šã™ã¹ããªã®ã‹ã‚ã‹ã‚‰ãªã„ã€‚
http://www.linux-mtd.infradead.org/faq/nand.html#L_nand_nandsim

ã©ã®ã‚ˆã†ãªå€¤ã‚’æŒ‡å®šã™ã‚‹ã®ã‹èª¬æ˜ã™ã‚‹ã€‚

nandsim ã¯ "Read ID" command ã«å¯¾ã™ã‚‹å¿œç­”ã‚’æŒ‡å®šã™ã‚‹ã€‚

ã‚³ãƒãƒ³ãƒ‰å¿œç­”ã®ä¸€ãƒã‚¤ãƒˆç›®ã‚’ first_id_byte(=Manufacturer ID) ã§æŒ‡å®šã—
ã‚³ãƒãƒ³ãƒ‰å¿œç­”ã®äºŒãƒã‚¤ãƒˆç›®ã‚’ second_id_byte(=Chip ID) ã§æŒ‡å®šã—
ã‚³ãƒãƒ³ãƒ‰å¿œç­”ã®ä¸‰ãƒã‚¤ãƒˆç›®ã‚’ third_id_byte  (æ„å‘³ã¯ Manufacturer ä¾å­˜)ã§æŒ‡å®šã—
ã‚³ãƒãƒ³ãƒ‰å¿œç­”ã®å››ãƒã‚¤ãƒˆç›®ã‚’ fourth_id_byte (æ„å‘³ã¯ Manufacturer ä¾å­˜)ã§æŒ‡å®šã™ã‚‹ã€‚

https://github.com/raspberrypi/linux/blob/a90c1b9c7da585b818e677cbd8c0b083bed42c4d/drivers/mtd/nand/raw/nandsim.c#L108-L111

ä»¥ä¸‹ã® P17

https://media-www.micron.com/-/media/client/onfi/pdfs/idf_s06_mems005_rev_h_usa.pdf?la=en&rev=b021e11bea7d454798841442acf33937


## æŒ‡å®šã™ã‚‹å€¤ (first_id_byte, ... fourth_id_byte)

### first_id_byte

ä¾‹ãˆã° Samsung ã¯ NAND_MFR_SAMSUNG(0xec)

NAND ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã® Manufacturer ID ã¯ä»¥ä¸‹ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€‚
https://github.com/raspberrypi/linux/blob/a90c1b9c7da585b818e677cbd8c0b083bed42c4d/drivers/mtd/nand/raw/internals.h#L19-L35


### second_id_byte

`nand_flash_ids` ã§å®šç¾©ã•ã‚ŒãŸ Chip Id å€¤ã‚’ second_id_byte ã§æŒ‡å®šã™ã‚‹ã€‚

https://github.com/raspberrypi/linux/blob/rpi-5.15.y/drivers/mtd/nand/raw/nand_ids.c#L23-L168

```
EXTENDED_ID_NAND("NAND 64MiB 1,8V 8-bit",  0xA2,  64, LP_OPTIONS),
```

ä¾‹ãˆã°ã€ä¸Šè¨˜ã®å®šç¾©ã§ `second_id_byte` ã¨ã—ã¦ `0xA2` ã‚’æŒ‡å®šã™ã‚‹ã¨ã€`NAND 64MiB 1,8V 8-bit` ã¨èªè­˜ã™ã‚‹ã€‚

### third_id_byte

ä»¥ä¸‹ã® P17

https://media-www.micron.com/-/media/client/onfi/pdfs/idf_s06_mems005_rev_h_usa.pdf?la=en&rev=b021e11bea7d454798841442acf33937

Samsung ã®å ´åˆã€don't care ãªã®ã§ä½•ã§ã‚‚è‰¯ã„ã€‚


### fourth_id_byte

ä»¥ä¸‹ã® P17

https://media-www.micron.com/-/media/client/onfi/pdfs/idf_s06_mems005_rev_h_usa.pdf?la=en&rev=b021e11bea7d454798841442acf33937

0x95 ã¾ãŸã¯ã€€0x15


## ä¾‹1

https://github.com/raspberrypi/linux/blob/rpi-5.15.y/drivers/mtd/nand/raw/nand_ids.c#L95

```
EXTENDED_ID_NAND("NAND 64MiB 1,8V 8-bit",  0xA2,  64, LP_OPTIONS),
```

```
modprobe nandsim first_id_byte=0xec  \
   second_id_byte=0xa2  \
   third_id_byte=0x51  \
   fourth_id_byte=0x95
```

â‡’

```
nand: Samsung NAND 64MiB 1,8V 8-bit
```

## ä¾‹2

https://github.com/raspberrypi/linux/blob/rpi-5.15.y/drivers/mtd/nand/raw/nand_ids.c#L114

```
EXTENDED_ID_NAND("NAND 256MiB 1,8V 8-bit",  0xAA, 256, LP_OPTIONS),
```

```
modprobe nandsim first_id_byte=0xec  \
   second_id_byte=0xaa  \
   third_id_byte=0x51  \
   fourth_id_byte=0x95
```

â‡’

```
nand: Samsung NAND 256MiB 1,8V 8-bit
```

## æŒ‡å®šã™ã‚‹å€¤ (parts)

first_id_byte, ... fourth_id_byte ã‚’æŒ‡å®šã—ãŸä¸Šã§ã€`parts` å¼•æ•°ã§ MTD partition ã‚’æŒ‡å®šã™ã‚‹ã€‚ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ MTD Partition ã®ã‚µã‚¤ã‚ºã‚’ Erase Size å˜ä½ã§æŒ‡å®šã™ã‚‹ã€‚

https://github.com/raspberrypi/linux/blob/a90c1b9c7da585b818e677cbd8c0b083bed42c4d/drivers/mtd/nand/raw/nandsim.c#L121

https://github.com/raspberrypi/linux/blob/a90c1b9c7da585b818e677cbd8c0b083bed42c4d/drivers/mtd/nand/raw/nandsim.c#L146


ã“ã“ã§ã¯ Erase Size ã¯ 128 KB ã ã¨æƒ³å®šã™ã‚‹ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã« `parts=8,8,8` ã¨æŒ‡å®šã—ãŸã¨ã™ã‚‹ã€‚

```
modprobe nandsim first_id_byte=0xec  \
   second_id_byte=0xaa  \
   third_id_byte=0x51  \
   fourth_id_byte=0x95 \
   parts=8,8,8
```

`NAND 256MiB 1,8V 8-bit` ã¨èªè­˜ã•ã‚Œã¦ã€mtd0, mtd1, mtd2 ã¯ 1MB ã®é ˜åŸŸã¨ã—ã¦èªè­˜ã•ã‚Œã¦æ®‹ã‚Šã®é ˜åŸŸãŒ mtd3 ã¨èªè­˜ã•ã‚Œã‚‹ã€‚

```
# dmesg | tail
[ 8549.758754] page address bytes: 5
[ 8549.758766] sector address bytes: 3
[ 8549.758779] options: 0x8
[ 8549.759881] Scanning device for bad blocks
[ 8549.780791] Creating 4 MTD partitions on "NAND 256MiB 1,8V 8-bit":
[ 8549.780826] 0x000000000000-0x000000100000 : "NAND simulator partition 0"
[ 8549.781472] 0x000000100000-0x000000200000 : "NAND simulator partition 1"
[ 8549.782150] 0x000000200000-0x000000300000 : "NAND simulator partition 2"
[ 8549.782659] 0x000000300000-0x000010000000 : "NAND simulator partition 3"
[ 8549.784765] [nandsim] warning: CONFIG_MTD_PARTITIONED_MASTER must be enabled to expose debugfs stuff
```

```
# cat /proc/mtd
dev:    size   erasesize  name
mtd0: 00100000 00020000 "NAND simulator partition 0"
mtd1: 00100000 00020000 "NAND simulator partition 1"
mtd2: 00100000 00020000 "NAND simulator partition 2"
mtd3: 0fd00000 00020000 "NAND simulator partition 3"
```

## å·¨å¤§ãª NAND ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ

```
EXTENDED_ID_NAND("NAND 16GiB 1,8V 8-bit",  0x1A, 16384, LP_OPTIONS),
```

16GB ã® NAND ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ãŸã„å ´åˆã€16GB ã® RAM ãŒå¿…è¦ã«ãªã‚‹ã€‚
32GB ã¨ã‹ã® RAM ã‚’ç©ã‚“ã§ã„ã‚Œã°å•é¡Œãªã„ãŒã€16GB ã—ã‹ç©ã‚“ã§ãªã„ã¨ã§ããªã„ã—
ã•ã‚‰ã«å¤§ããª NAND ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹å ´åˆã«ã¯ä¸å¯èƒ½ã«ãªã‚‹ã€‚

`cache_file` å¼•æ•°ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ RAM ã®ä»£ã‚ã‚Šã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šã« NAND ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã§ãã‚‹ã€‚

https://github.com/raspberrypi/linux/blob/a90c1b9c7da585b818e677cbd8c0b083bed42c4d/drivers/mtd/nand/raw/nandsim.c#L128


https://github.com/raspberrypi/linux/blob/a90c1b9c7da585b818e677cbd8c0b083bed42c4d/drivers/mtd/nand/raw/nandsim.c#L162

### cache_file å¼•æ•°ã‚’æŒ‡å®šã—ã¦ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚

```
# modprobe nandsim first_id_byte=0xec  \
   second_id_byte=0x1A  \
   third_id_byte=0x51  \
   fourth_id_byte=0x95 \
   cache_file=nandfile \
   parts=8,8,8
```

### NAND ãŒèªè­˜ã•ã‚Œã¦ã„ã‚‹ã€‚

```
# dmesg | tail
[50521.664480] page address bytes: 5
[50521.664481] sector address bytes: 3
[50521.664481] options: 0x8
[50521.664697] Scanning device for bad blocks
[50521.737064] Creating 4 MTD partitions on "NAND 16GiB 1,8V 8-bit":
[50521.737071] 0x000000000000-0x000000100000 : "NAND simulator partition 0"
[50521.738814] 0x000000100000-0x000000200000 : "NAND simulator partition 1"
[50521.740299] 0x000000200000-0x000000300000 : "NAND simulator partition 2"
[50521.741339] 0x000000300000-0x000400000000 : "NAND simulator partition 3"
[50521.748288] [nandsim] warning: CONFIG_MTD_PARTITIONED_MASTER must be enabled to expose debugfs stuff
```

### æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹ã€‚æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ç©ºãƒ•ã‚¡ã‚¤ãƒ«ã€‚

```
# ls
nandfile  snap
# ls -l
åˆè¨ˆ 4
-rw------- 1 root root    0  8æœˆ 15 08:09 nandfile
drwx------ 5 root root 4096  7æœˆ 17 23:05 snap
```

### mtd-tools ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```
# apt install -y mtd-tools
```

### `/dev/mtd3` ã‚’ format ã™ã‚‹

```
# ubiformat /dev/mtd3
ubiformat: mtd3 (nand), size 17176723456 bytes (15.9 GiB), 131048 eraseblocks of 131072 bytes (128.0 KiB), min. I/O size 2048 bytes
libscan: scanning eraseblock 131047 -- 100 % complete
ubiformat: 131048 eraseblocks are supposedly empty
ubiformat: formatting eraseblock 131047 -- 100 % complete
```

### æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹ã€‚æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ 16GiB ã«ãªã£ãŸã€‚

```
# ls -lh
åˆè¨ˆ 514M
-rw------- 1 root root  17G  8æœˆ 15 08:16 nandfile
drwx------ 5 root root 4.0K  7æœˆ 17 23:05 snap
# ls -l
åˆè¨ˆ 524476
-rw------- 1 root root 17716607040  8æœˆ 15 08:16 nandfile
drwx------ 5 root root        4096  7æœˆ 17 23:05 snap
```
